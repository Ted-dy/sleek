package me.kansio.client.modules.impl.exploit;

import com.google.common.eventbus.Subscribe;
import me.kansio.client.event.impl.PacketEvent;
import me.kansio.client.modules.api.ModuleCategory;
import me.kansio.client.modules.api.ModuleData;
import me.kansio.client.modules.impl.Module;
import me.kansio.client.value.value.BooleanValue;
import me.kansio.client.utils.math.Stopwatch;
import me.kansio.client.utils.chat.ChatUtil;
import net.minecraft.network.play.client.C14PacketTabComplete;
import net.minecraft.network.play.server.S3APacketTabComplete;

import java.util.Arrays;

@ModuleData(
        name = "Plugins",
        category = ModuleCategory.EXPLOIT,
        description = "Attempts to show you the plugins on the server"
)
public class Plugins extends Module {

    private Stopwatch timer = new Stopwatch();
    private BooleanValue slashAbout = new BooleanValue("/About", this, false);
    boolean differentMethod = false;

    public void onEnable() {
        timer.resetTime();
        boolean differentMethod = false;
        mc.getNetHandler().getNetworkManager().sendPacket(new C14PacketTabComplete("/"));
        ChatUtil.log("Listening for a S3APacketTabComplete for 20s!");
    }

    @Subscribe
    public void onPacket(PacketEvent event) {
        if (event.getPacket() instanceof S3APacketTabComplete) {
            S3APacketTabComplete packet = event.getPacket();
            String[] commands = packet.func_149630_c();
            System.out.println(Arrays.toString(commands));
            String message = "";
            int size = 0;

            if (!differentMethod) {
                for (String command : commands) {
                    String pluginName = command.split(":")[0].substring(1);

                    if (!message.contains(pluginName) && command.contains(":") && !pluginName.equalsIgnoreCase("minecraft") && !pluginName.equalsIgnoreCase("bukkit")) {
                        size++;
                        if (message.isEmpty()) {
                            message += pluginName;
                        } else {
                            message += "\2478, \247a" + pluginName;
                        }
                    }
                }
            } else {
                for (String command : commands) {
                    if (message.isEmpty()) {
                        message += command;
                    } else {
                        message += "\2478, \247a" + command;
                    }
                }
            }

            if (!message.isEmpty()) {
                ChatUtil.log("\2477Plugins (\247f" + size + "\2477): \247a " + message + "\2477.");
            } else {
                ChatUtil.log("Plugins: none.");
            }
            toggle();
            event.setCancelled(true);
        }

        if (timer.timeElapsed(20000)) {
            toggle();
            if (slashAbout.getValue()) {
                ChatUtil.log("Stopped listening for an S3APacketTabComplete! Took to long (20s)! trying different method");
                mc.getNetHandler().getNetworkManager().sendPacket(new C14PacketTabComplete("/about "));
                timer.resetTime();
                boolean differentMethod = true;
            } else {
                ChatUtil.log("Stopped listening for an S3APacketTabComplete! Took to long (20s)!");
            }
        }
    }


}